Version = -1

function GetRemote(url)
    local file = http.get(url)
    if file == nil then
        return nil
    end
    local content = file.readAll()
    file.close()
    return content
end

function GetRepo()
    local repo = "https://raw.githubusercontent.com/bldng1337/computercraft/refs/heads/main"

    local indexraw = GetRemote(repo .. "/index.json")
    if indexraw == nil then
        print("Failed to get index update check failed")
        return
    end
    local index = textutils.unserialiseJSON(indexraw)

    local versionfile = fs.open("version", "r")
    if versionfile ~= nil then
        local content
        content = versionfile.readAll()
        versionfile.close()
        local version = textutils.unserialiseJSON(content)
        if version.version == index.version then
            print("Version is up to date")
            Version = version.version
            return
        end
    end


    print("Version is out of date updating")
    for _, v in pairs(index.files) do
        print("Downloading " .. v)
        local file = GetRemote(repo .. "/" .. v)
        if file ~= nil then
            local f = fs.open(v, "w")
            f.write(file)
            f.close()
        end
    end
    Version = index.version
    local versionfile = fs.open("version", "w")
    if versionfile ~= nil then
        versionfile.write(textutils.serialiseJSON(index))
        versionfile.close()
    end
end

GetRepo()
print("Started Version: " .. Version)
print("Fuel Level: " ..
    turtle.getFuelLevel() ..
    "/" .. turtle.getFuelLimit() .. " (" .. (turtle.getFuelLevel() / turtle.getFuelLimit() * 100) .. "%)")
